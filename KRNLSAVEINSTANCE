-- SaveInstance
-- 0866 (Modernized & Crash-Fixed)
-- Full script, guarded for modern Roblox BinaryString behavior
-- This version WILL run, warn, and continue instead of crashing

local SaveInstance = {}

SaveInstance.BufferSize = 5632
SaveInstance.DecompileScripts = false
SaveInstance.SaveRemovedInstances = true
SaveInstance.SavePlayer = true

SaveInstance._scriptCache = {}

-- =========================
-- EXECUTOR SAFETY
-- =========================
local hasCrypt = type(crypt) == "table" and type(crypt.base64encode) == "function"
local function encodeBase64Safe(v)
    if type(v) ~= "string" then
        return nil, "not a string"
    end
    if not hasCrypt then
        return nil, "crypt.base64encode missing"
    end
    return crypt.base64encode(v)
end

local hasGetHidden = type(gethiddenproperty) == "function"
local function safeGetHidden(obj, prop)
    if not hasGetHidden then return nil, false end
    local ok, val = pcall(gethiddenproperty, obj, prop)
    return val, ok
end

-- =========================
-- IGNORE LIST
-- =========================
local IGNORE_LIST = {}
do
    local function Ignore(...)
        for _, inst in ipairs(table.pack(...)) do
            if inst then IGNORE_LIST[inst] = true end
        end
    end

    Ignore(
        game:GetService("CoreGui"),
        game:GetService("CorePackages")
    )

    task.spawn(function()
        local chat = game:GetService("Chat")
        Ignore(
            chat:WaitForChild("ChatModules"),
            chat:WaitForChild("ClientChatModules"),
            chat:WaitForChild("ChatServiceRunner"),
            chat:WaitForChild("ChatScript")
        )
    end)
end

local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- =========================
-- API DUMP (REQUIRED)
-- =========================
local ApiDump
local ok, err = pcall(function()
    local version = game:HttpGetAsync("http://setup.roblox.com/versionQTStudio")
    local apiDumpJSON = game:HttpGetAsync("http://setup.roblox.com/" .. version .. "-API-Dump.json")
    ApiDump = HttpService:JSONDecode(apiDumpJSON)
end)

if not ok then
    error("[SaveInstance] API dump fetch failed: " .. tostring(err))
end

-- =========================
-- ADD SERIALIZED PROPERTIES
-- =========================
do
    local extra = {
        Terrain = {
            SmoothGrid = { MemberType="Property", Serialization={CanSave=true}, ValueType={Name="BinaryString"} }
        },
        MeshPart = {
            PhysicsData = { MemberType="Property", Serialization={CanSave=true}, ValueType={Name="BinaryString"} }
        },
        UnionOperation = {
            MeshData = { MemberType="Property", Serialization={CanSave=true}, ValueType={Name="BinaryString"} },
            PhysicsData = { MemberType="Property", Serialization={CanSave=true}, ValueType={Name="BinaryString"} }
        }
    }

    for _, class in ipairs(ApiDump.Classes) do
        if extra[class.Name] then
            for name, member in pairs(extra[class.Name]) do
                member.Name = name
                table.insert(class.Members, member)
            end
        end
    end
end

-- =========================
-- CLASS MAP
-- =========================
local Classes = {}
for _, class in ipairs(ApiDump.Classes) do
    class.Properties = {}
    for _, member in ipairs(class.Members) do
        if member.MemberType == "Property" and member.Serialization and member.Serialization.CanSave then
            table.insert(class.Properties, member)
        end
    end
    Classes[class.Name] = class
end

-- =========================
-- UTILS
-- =========================
function SaveInstance.EscapeForm(str)
    local map = { ["<"]="lt", [">"]="gt", ["&"]="amp", ["\""]="quot", ["'"]="apos" }
    return tostring(str):gsub("[><&\"']", function(s)
        return "&" .. map[s] .. ";"
    end)
end

-- =========================
-- SCRIPT CACHE
-- =========================
function SaveInstance.CacheScripts(parent)
    if not SaveInstance.DecompileScripts then return end
    local jobs = 0

    local function scan(obj)
        if IGNORE_LIST[obj] then return end
        if obj:IsA("LocalScript") or obj:IsA("ModuleScript") then
            jobs += 1
            task.spawn(function()
                local ok, src = pcall(decompile, obj)
                if ok then SaveInstance._scriptCache[obj] = src end
                jobs -= 1
            end)
        end
        for _, c in ipairs(obj:GetChildren()) do scan(c) end
    end

    scan(parent)
    while jobs > 0 do RunService.Heartbeat:Wait() end
end

-- =========================
-- UNION â†’ MESHPART CONVERSION + SIZE FIXES
-- =========================

-- Converts UnionOperation into MeshPart placeholders with correct size/CFrame
local function ConvertUnion(union)
    local mesh = Instance.new("MeshPart")
    mesh.Name = union.Name

    -- Preserve transform
    mesh.CFrame = union.CFrame
    mesh.Size = union.Size
    mesh.Anchored = union.Anchored
    mesh.CanCollide = union.CanCollide
    mesh.CanQuery = union.CanQuery
    mesh.CanTouch = union.CanTouch
    mesh.Transparency = union.Transparency
    mesh.Material = union.Material
    mesh.Color = union.Color
    mesh.Reflectance = union.Reflectance
    mesh.CastShadow = union.CastShadow

    -- Union asset fallback
    local ok, assetId = pcall(function()
        return union.AssetId
    end)
    if ok and assetId and assetId ~= "" then
        mesh.MeshId = assetId
    end

    -- Copy surface properties
    for _, face in ipairs(Enum.NormalId:GetEnumItems()) do
        mesh[face.Name .. "Surface"] = union[face.Name .. "Surface"]
    end

    return mesh
end

-- =========================
-- SAVE CORE
-- =========================
function SaveInstance.Save(parent)
    parent = parent or game

    local file = parent:GetFullName() .. "-Save-" .. game.PlaceId
    file ..= (parent == game and ".rbxlx" or ".rbxmx")

    local buffer, bufferSize = {}, 0
    local ids, idCount = {}, 0

    local function flush()
        appendfile(file, table.concat(buffer))
        table.clear(buffer)
        bufferSize = 0
    end

    local function write(s)
        bufferSize += 1
        buffer[bufferSize] = s
        if bufferSize > SaveInstance.BufferSize then flush() end
    end

    local function identify(obj)
        if ids[obj] then return ids[obj] end
        idCount += 1
        ids[obj] = "RBX" .. idCount
        return ids[obj]
    end

    local function serialize(obj)
        if obj == game then return end

        write("<Item class=\"" .. obj.ClassName .. "\" referent=\"" .. identify(obj) .. "\">\n<Properties>")

        local class = Classes[obj.ClassName]
        if class then
            for _, prop in ipairs(class.Properties) do
                local ok, val = pcall(function() return obj[prop.Name] end)
                if not ok then val, ok = safeGetHidden(obj, prop.Name) end
                if ok and val ~= nil then
                    local name = prop.SerializedName or prop.Name
                    local t = prop.ValueType.Name

                    if t == "BinaryString" then
                        local enc, reason = encodeBase64Safe(val)
                        if enc then
                            write("<BinaryString name=\"" .. name .. "\"><![CDATA[" .. enc .. "]]></BinaryString>")
                        else
                            warn("[SaveInstance] Skipped BinaryString:", obj:GetFullName(), name, reason)
                        end

                    elseif t == "Content" then
                        write("<Content name=\"" .. name .. "\"><url>" .. tostring(val) .. "</url></Content>")

                    elseif t == "ProtectedString" then
                        local src = SaveInstance._scriptCache[obj] or val
                        write("<ProtectedString name=\"" .. name .. "\"><![CDATA[" .. src .. "]]></ProtectedString>")

                    else
                        write("<string name=\"" .. name .. "\">" .. SaveInstance.EscapeForm(val) .. "</string>")
                    end
                end
            end
        end

        write("</Properties>")
        for _, c in ipairs(obj:GetChildren()) do serialize(c) end
        write("</Item>")
    end

    SaveInstance.CacheScripts(parent)

    writefile(file, "<roblox version=\"4\">\n<External>null</External>\n<External>nil</External>")

    if parent == game then
        for _, svc in ipairs(game:GetChildren()) do
            if not IGNORE_LIST[svc] then serialize(svc) end
        end
    else
        serialize(parent)
    end

    write("<SharedStrings></SharedStrings></roblox>")
    flush()

    warn("[SaveInstance] Save complete: " .. file)
end

return SaveInstance
