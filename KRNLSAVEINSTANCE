-- Safe SaveInstance
local SaveInstance = {}

SaveInstance.BufferSize = 5632
SaveInstance.DecompileScripts = false
SaveInstance.SaveRemovedInstances = true
SaveInstance.SavePlayer = true

SaveInstance._scriptCache = {}

local encodeBase64 = crypt and crypt.base64encode or function() return "" end
local gethiddenproperty = gethiddenproperty or error

-- List of instances we will NEVER serialize
local IGNORE_LIST = {} do
    local function Ignore(...)
        for _,instance in ipairs(table.pack(...)) do
            if (instance) then
                IGNORE_LIST[instance] = true
            end
        end
    end

    Ignore(
        game:GetService("CoreGui"),
        game:GetService("CorePackages"),
        game:GetService("Players")
    )

    coroutine.wrap(function()
        local chat = game:GetService("Chat")
        Ignore(
            chat:WaitForChild("ChatModules"),
            chat:WaitForChild("ClientChatModules"),
            chat:WaitForChild("ChatServiceRunner"),
            chat:WaitForChild("ChatScript")
        )
    end)()
end

local RunService = game:GetService("RunService")

-- Escape XML special characters
function SaveInstance.EscapeForm(str)
    local entityMap = { ["<"]="lt", [">"]="gt", ["&"]="amp", ["\""]="quot", ["'"]="apos" }
    return str:gsub("[><&\"']", function(s)
        return ("&" .. entityMap[s] .. ";")
    end)
end

-- Cache scripts if decompile enabled
function SaveInstance.CacheScripts(parent)
    if (not SaveInstance.DecompileScripts) then return end
    assert(typeof(parent) == "Instance", "Argument #1 'parent' must be Instance")

    local jobs = 0
    local function Cache(inst)
        if IGNORE_LIST[inst] then return end
        if inst:IsA("ModuleScript") or inst:IsA("LocalScript") then
            jobs += 1
            spawn(function()
                local ok, res = pcall(decompile, inst)
                if ok then SaveInstance._scriptCache[inst] = res end
                jobs -= 1
            end)
        end
        for _,c in ipairs(inst:GetChildren()) do
            Cache(c)
        end
    end
    Cache(parent)
    while jobs > 0 do RunService.Heartbeat:Wait() end
end

-- Serialize instances safely
function SaveInstance.Save(parent)
    parent = parent or game
    local fileName = parent:GetFullName() .. "-SafeSave-" .. game.PlaceId
    if parent.Parent == game or parent == game then fileName ..= ".rbxlx" else fileName ..= ".rbxmx" end

    local buffer, bufferSize = {}, 0
    local instanceIds, instanceCount = {}, 0

    local function Flush()
        appendfile(fileName, table.concat(buffer))
        table.clear(buffer)
        bufferSize = 0
    end
    local function Insert(str)
        bufferSize += 1
        buffer[bufferSize] = str
    end
    local function Identify(inst)
        if instanceIds[inst] then return instanceIds[inst] end
        instanceCount += 1
        instanceIds[inst] = "RBX" .. instanceCount
        return "RBX" .. instanceCount
    end

    local function Serialize(inst, children)
        if inst == game then return end
        if IGNORE_LIST[inst] then return end
        if bufferSize > SaveInstance.BufferSize then Flush() end

        local className = inst.ClassName
        if className == "PlayerScripts" or className == "PlayerGui" then
            className = "Folder"
        end

        Insert("<Item class=\"" .. className .. "\" referent=\"" .. Identify(inst) .. "\">\n<Properties>")

        local success, members = pcall(function()
            return inst:GetAttributes()
        end)
        if success and members then
            for propName, value in pairs(members) do
                Insert("<string name=\"" .. propName .. "\">" .. tostring(value) .. "</string>")
            end
        end

        -- Serialize children recursively
        for _,c in ipairs(children or inst:GetChildren()) do
            Serialize(c)
        end
        Insert("</Properties></Item>")
    end

    SaveInstance.CacheScripts(parent)

    writefile(fileName, "<roblox version=\"4\">\n")
    if parent == game then
        for _,service in ipairs(game:GetChildren()) do
            if not IGNORE_LIST[service] then
                Serialize(service)
            end
        end
    else
        Serialize(parent)
    end
    Insert("</roblox>")
    Flush()
    print("[SaveInstance] Safe save complete: " .. fileName)
end

return SaveInstance
