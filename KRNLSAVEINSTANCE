-- SaveInstance with full Union/MeshPart fidelity
-- Version 0866-Fix

local SaveInstance = {}

SaveInstance.BufferSize = 5632
SaveInstance.DecompileScripts = false
SaveInstance.SaveRemovedInstances = true
SaveInstance.SavePlayer = true

SaveInstance._scriptCache = {}

local encodeBase64 = crypt and crypt.base64encode or function() return "" end
local gethiddenproperty = gethiddenproperty or error

local IGNORE_LIST = {} do
    local function Ignore(...)
        for _,instance in ipairs(table.pack(...)) do
            if (not instance) then continue end
            IGNORE_LIST[instance] = true
        end
    end

    Ignore(
        game:GetService("CoreGui"),
        game:GetService("CorePackages"),
        game:GetService("Players")
    )

    coroutine.resume(coroutine.create(function()
        local chat = game:GetService("Chat")
        Ignore(
            chat:WaitForChild("ChatModules"),
            chat:WaitForChild("ClientChatModules"),
            chat:WaitForChild("ChatServiceRunner"),
            chat:WaitForChild("ChatScript")
        )
    end))
end

local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- Load API dump
local ApiDump do
    local version = game:HttpGetAsync("http://setup.roblox.com/versionQTStudio")
    local apiDumpJSON = game:HttpGetAsync("http://setup.roblox.com/" .. version .. "-API-Dump.json")
    ApiDump = HttpService:JSONDecode(apiDumpJSON)
end

-- Classes mapping
local Classes = {} do
    for _,class in ipairs(ApiDump.Classes) do
        class.Properties = {}
        for _,member in ipairs(class.Members) do
            if member.MemberType == "Property" and member.Serialization.CanSave then
                table.insert(class.Properties, member)
            end
        end
        Classes[class.Name] = class
    end
end

-- Escape XML
function SaveInstance.EscapeForm(str)
    local entityMap = { ["<"]="lt", [">"]="gt", ["&"]="amp", ["\""]="quot", ["'"]="apos" }
    return str:gsub("[><&\"']", function(s) return "&" .. entityMap[s] .. ";" end)
end

-- Cache scripts
function SaveInstance.CacheScripts(parent)
    if not SaveInstance.DecompileScripts then return end
    assert(typeof(parent) == "Instance", "Argument #1 must be Instance")

    local jobCount = 0
    local function Cache(instance)
        if IGNORE_LIST[instance] then return end
        if instance:IsA("LocalScript") or instance:IsA("ModuleScript") then
            jobCount += 1
            spawn(function()
                local ok, result = pcall(decompile, instance)
                if ok then SaveInstance._scriptCache[instance] = result end
                jobCount -= 1
            end)
        end
        for _,child in ipairs(instance:GetChildren()) do Cache(child) end
    end

    Cache(parent)
    while jobCount > 0 do RunService.Heartbeat:Wait() end
end

-- Convert Union -> MeshPart/SpecialMesh
local function convertUnion(instance)
    if instance:IsA("UnionOperation") then
        local newPart = Instance.new("Part")
        newPart.Size = instance.Size
        newPart.Position = instance.Position
        newPart.Orientation = instance.Orientation
        newPart.Material = instance.Material
        newPart.BrickColor = instance.BrickColor
        newPart.Anchored = instance.Anchored
        newPart.CanCollide = instance.CanCollide

        local mesh = Instance.new("SpecialMesh")
        mesh.MeshType = Enum.MeshType.FileMesh
        mesh.MeshId = instance.MeshId or ""
        mesh.TextureId = instance.TextureID or ""
        mesh.Scale = Vector3.new(1,1,1)
        mesh.Parent = newPart

        newPart.Name = instance.Name
        return newPart
    end
    return instance
end

-- Correct color
local function fixColor(instance)
    if instance:IsA("BasePart") then
        instance.Color = instance.Color
        instance.BrickColor = instance.BrickColor
    end
end

-- Correct sizing
local function fixSize(instance)
    if instance:IsA("UnionOperation") then
        local _, size = pcall(function() return instance.Size end)
        if size then instance.Size = size end
    elseif instance:IsA("MeshPart") then
        instance.Size = instance.Size
    end
end

-- Identify
local instanceIds = {}
local instanceCount = 0
local function Identify(instance)
    local id = instanceIds[instance]
    if id then return id end
    instanceCount += 1
    instanceIds[instance] = "RBX" .. instanceCount
    return "RBX" .. instanceCount
end

-- Serialize instance
local buffer = {}
local bufferSize = 0
local function Flush(file)
    appendfile(file, table.concat(buffer))
    table.clear(buffer)
    bufferSize = 0
end

local function Insert(entry)
    bufferSize += 1
    buffer[bufferSize] = entry
end

local function Serialize(instance, children, file)
    instance = convertUnion(instance)
    fixColor(instance)
    fixSize(instance)

    Insert("<Item class='" .. instance.ClassName .. "' referent='" .. Identify(instance) .. "'>\n<Properties>")
    for _,property in ipairs(Classes[instance.ClassName] and Classes[instance.ClassName].Properties or {}) do
        local success, value = pcall(function() return instance[property.Name] end)
        if not success then continue end
        Insert("<" .. property.Name .. ">" .. tostring(value) .. "</" .. property.Name .. ">")
    end
    Insert("</Properties>")

    for _,child in ipairs(children or instance:GetChildren()) do Serialize(child, nil, file) end
    Insert("</Item>")
end

-- Main Save
function SaveInstance.Save(parent)
    parent = parent or game
    local file = parent:GetFullName() .. "-Save-" .. game.PlaceId
    if parent.Parent == game or parent == game then file ..= ".rbxlx" else file ..= ".rbxmx" end

    SaveInstance.CacheScripts(parent)
    writefile(file, "<roblox version='4'>")

    if parent == game then
        for _,service in ipairs(game:GetChildren()) do
            if IGNORE_LIST[service] then continue end
            Serialize(service, nil, file)
        end
    else
        Serialize(parent, nil, file)
    end

    Insert("</roblox>")
    Flush(file)
    print("[SaveInstance] Save complete: " .. file)
end

return SaveInstance
