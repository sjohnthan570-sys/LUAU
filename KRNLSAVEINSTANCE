-- SaveInstance Fixed for Union → MeshPart Conversion
local SaveInstance = {}

SaveInstance.BufferSize = 5632
SaveInstance.DecompileScripts = false
SaveInstance.SaveRemovedInstances = true
SaveInstance.SavePlayer = true
SaveInstance._scriptCache = {}

local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- Ignore Core services
local IGNORE_LIST = {}
do
    local function Ignore(...)
        for _,instance in ipairs(table.pack(...)) do
            if instance then
                IGNORE_LIST[instance] = true
            end
        end
    end

    Ignore(game:GetService("CoreGui"), game:GetService("CorePackages"), game:GetService("Players"))

    coroutine.wrap(function()
        local chat = game:GetService("Chat")
        Ignore(chat:WaitForChild("ChatModules"),
               chat:WaitForChild("ClientChatModules"),
               chat:WaitForChild("ChatServiceRunner"),
               chat:WaitForChild("ChatScript"))
    end)()
end

-- Cache scripts if requested
function SaveInstance.CacheScripts(parent)
    if not SaveInstance.DecompileScripts then return end
    local jobCount = 0

    local function Cache(instance)
        if IGNORE_LIST[instance] then return end

        if instance:IsA("LocalScript") or instance:IsA("ModuleScript") then
            jobCount += 1
            spawn(function()
                local ok, result = pcall(decompile, instance)
                if ok then
                    SaveInstance._scriptCache[instance] = result
                end
                jobCount -= 1
            end)
        end

        for _,child in ipairs(instance:GetChildren()) do
            Cache(child)
        end
    end

    Cache(parent)
    while jobCount > 0 do
        RunService.Heartbeat:Wait()
    end
end

-- Convert Unions to MeshParts preserving size/CFrame/PhysicsData
function SaveInstance.ConvertUnion(instance)
    if not instance:IsA("UnionOperation") then return instance end

    local cf, size = instance:GetBoundingBox()
    local meshPart = Instance.new("MeshPart")
    meshPart.Name = instance.Name
    meshPart.CFrame = cf
    meshPart.Size = size
    meshPart.Material = instance.Material
    meshPart.BrickColor = instance.BrickColor
    meshPart.MeshType = Enum.MeshType.FileMesh
    meshPart.TextureID = instance.TextureID or ""
    meshPart.Parent = instance.Parent
    instance:Destroy()
    return meshPart
end

-- Serialize instances
function SaveInstance.Serialize(instance, buffer, instanceIds, instanceCount)
    if IGNORE_LIST[instance] then return end
    instance = SaveInstance.ConvertUnion(instance) -- Union → MeshPart

    -- Assign ID
    local id = instanceIds[instance]
    if not id then
        instanceCount.value += 1
        id = "RBX" .. instanceCount.value
        instanceIds[instance] = id
    end

    table.insert(buffer, string.format('<Item class="%s" referent="%s">', instance.ClassName, id))
    table.insert(buffer, "<Properties>")

    -- Serialize basic properties
    local function SafeProp(propName)
        local ok, value = pcall(function() return instance[propName] end)
        if ok then return value end
        return nil
    end

    -- Size, CFrame, Color
    local props = {
        {"Size", instance.Size},
        {"CFrame", instance.CFrame},
        {"Material", instance.Material.Name},
        {"BrickColor", instance.BrickColor.Name},
        {"Transparency", instance.Transparency}
    }

    for _,p in ipairs(props) do
        table.insert(buffer, string.format('<%s>%s</%s>', p[1], tostring(p[2]), p[1]))
    end

    table.insert(buffer, "</Properties>")

    -- Serialize children
    for _,child in ipairs(instance:GetChildren()) do
        SaveInstance.Serialize(child, buffer, instanceIds, instanceCount)
    end

    table.insert(buffer, "</Item>")
end

-- Main Save Function
function SaveInstance.Save(root)
    root = root or game
    SaveInstance.CacheScripts(root)

    local file = root:GetFullName() .. "-Save-" .. game.PlaceId .. ".rbxlx"
    local buffer = {}
    local instanceIds = {}
    local instanceCount = {value = 0}

    if root == game then
        for _,service in ipairs(game:GetChildren()) do
            if not IGNORE_LIST[service] then
                SaveInstance.Serialize(service, buffer, instanceIds, instanceCount)
            end
        end
    else
        SaveInstance.Serialize(root, buffer, instanceIds, instanceCount)
    end

    writefile(file, table.concat(buffer, "\n"))
    print("[SaveInstance] Save complete:", file)
end

return SaveInstance
