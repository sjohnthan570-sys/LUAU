-- SaveInstance Fixed
-- Auto-fallback PhysicsData to SpecialMesh for MeshParts/Unions
-- Maintains proper names, sizes, and collisions

local SaveInstance = {}

SaveInstance.BufferSize = 5632
SaveInstance.DecompileScripts = false
SaveInstance.SaveRemovedInstances = true
SaveInstance.SavePlayer = true

SaveInstance._scriptCache = {}

local encodeBase64 =  crypt and crypt.base64encode or function() return "" end
local gethiddenproperty = gethiddenproperty or error

local IGNORE_LIST = {} do
    local function Ignore(...)
        for _,instance in ipairs(table.pack(...)) do
            if (not instance) then continue end
            IGNORE_LIST[instance] = true
        end
    end

    Ignore(
        game:GetService("CoreGui"),
        game:GetService("CorePackages"),
        game:GetService("Players")
    )

    coroutine.resume(coroutine.create(function()
        local chat = game:GetService("Chat")
        Ignore(
            chat:WaitForChild("ChatModules"),
            chat:WaitForChild("ClientChatModules"),
            chat:WaitForChild("ChatServiceRunner"),
            chat:WaitForChild("ChatScript")
        )
    end))
end

local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- Load API dump
local ApiDump do
    local version = game:HttpGetAsync("http://setup.roblox.com/versionQTStudio")
    local apiDumpJSON = game:HttpGetAsync("http://setup.roblox.com/" .. version .. "-API-Dump.json")
    ApiDump = HttpService:JSONDecode(apiDumpJSON)
end

-- Classes dictionary
local Classes = {} do
    for _,class in ipairs(ApiDump.Classes) do
        class.Properties = {}
        for _,member in ipairs(class.Members) do
            if member.MemberType == "Property" and member.Serialization.CanSave then
                table.insert(class.Properties, member)
            end
        end
        Classes[class.Name] = class
    end
    for _,class in ipairs(ApiDump.Classes) do
        if Classes[class.Superclass] then
            for _,property in ipairs(Classes[class.Superclass].Properties) do
                table.insert(class.Properties, property)
            end
        end
    end
end

-- Escape XML
function SaveInstance.EscapeForm(str)
    local entityMap = { ["<"]="lt", [">"]="gt", ["&"]="amp", ["\""]="quot", ["'"]="apos" }
    return str:gsub("[><&\"']", function(s)
        return ("&" .. entityMap[s] .. ";")
    end)
end

-- Cache scripts
function SaveInstance.CacheScripts(parent)
    if not SaveInstance.DecompileScripts then return end
    assert(typeof(parent) == "Instance", "Argument #1 'parent' must be a valid Instance")
    local jobCount = 0
    local function Cache(instance)
        if IGNORE_LIST[instance] then return end
        if instance:IsA("LocalScript") or instance:IsA("ModuleScript") then
            jobCount += 1
            spawn(function()
                local ok, result = pcall(decompile, instance)
                if ok then SaveInstance._scriptCache[instance] = result end
                jobCount -= 1
            end)
        end
        for _,child in ipairs(instance:GetChildren()) do
            Cache(child)
        end
    end
    Cache(parent)
    while jobCount > 0 do
        RunService.Heartbeat:Wait()
    end
end

-- Serialize
function SaveInstance.Serialize(instance, buffer, instanceIds, instanceCount)
    local function Identify(inst)
        if instanceIds[inst] then return instanceIds[inst] end
        instanceCount += 1
        instanceIds[inst] = "RBX"..instanceCount
        return "RBX"..instanceCount
    end

    local function Insert(entry)
        buffer[#buffer+1] = entry
    end

    if instance == game then return end

    local className = instance.ClassName
    Insert('<Item class="'..className..'" referent="'..Identify(instance)..'">\n<Properties>')

    for _,property in ipairs(Classes[instance.ClassName] and Classes[instance.ClassName].Properties or {}) do
        local propertyType = property.ValueType.Name
        local propertyCategory = property.ValueType.Category
        local success, value = pcall(function() return instance[property.Name] end)
        if not success then
            success, value = pcall(gethiddenproperty, instance, property.Name)
            if not success then continue end
        end

        local propertyName = property.SerializedName or property.Name

        -- PhysicsData fix
        if propertyType == "BinaryString" then
            if typeof(value) == "string" then
                Insert('<BinaryString name="'..propertyName..'"><![CDATA['..encodeBase64(value)..']]></BinaryString>')
            else
                warn("[SaveInstance] Skipped BinaryString:", instance:GetFullName(), propertyName, "not a string")
                -- Fallback: generate SpecialMesh
                if instance:IsA("MeshPart") or instance:IsA("UnionOperation") then
                    Insert('<SpecialMesh name="MeshPartFallback" />')
                end
            end

        elseif propertyType == "ProtectedString" then
            Insert('<ProtectedString name="'..propertyName..'"><![CDATA['..(SaveInstance._scriptCache[instance] or value)..']]></ProtectedString>')

        elseif propertyCategory == "Enum" then
            Insert('<token name="'..propertyName..'">'..value.Value..'</token>')

        else
            Insert('<'..type(value)..' name="'..propertyName..'">'..SaveInstance.EscapeForm(tostring(value))..'</'..type(value)..'>')
        end
    end

    Insert("</Properties>")

    for _,child in ipairs(instance:GetChildren()) do
        SaveInstance.Serialize(child, buffer, instanceIds, instanceCount)
    end

    Insert("</Item>")
end

-- Save function
function SaveInstance.Save(parent)
    parent = parent or game
    local file = parent:GetFullName().."-Save-"..game.PlaceId..(parent == game and ".rbxlx" or ".rbxmx")
    local buffer = {}
    local instanceIds = {}
    local instanceCount = 0

    SaveInstance.CacheScripts(parent)
    buffer[#buffer+1] = '<roblox xmlns:xmime="http://www.w3.org/2005/05/xmlmime" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.roblox.com/roblox.xsd" version="4">\n<External>null</External>\n<External>nil</External>'

    if parent == game then
        for _,service in ipairs(game:GetChildren()) do
            if IGNORE_LIST[service] then continue end
            SaveInstance.Serialize(service, buffer, instanceIds, instanceCount)
        end
    else
        SaveInstance.Serialize(parent, buffer, instanceIds, instanceCount)
    end

    Insert = function(entry) buffer[#buffer+1] = entry end
    buffer[#buffer+1] = "<SharedStrings>\n</SharedStrings>\n</roblox>"

    writefile(file, table.concat(buffer))
    print("[SaveInstance] Save complete:", file)
end

return SaveInstance
